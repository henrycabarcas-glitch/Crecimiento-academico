
/**
 * Core Philosophy: This ruleset enforces a role-based access control model for a school management system.
 * Access is granted based on the user's assigned role (e.g., 'Administrador', 'Profesor'), which is stored
 * in their document within the `/teachers` collection. This model prioritizes data integrity and ensures that
 * users can only perform actions relevant to their responsibilities.
 *
 * Data Structure: The data is organized into top-level collections for primary entities like 'students',
 * 'teachers', and 'courses'. Sensitive, student-specific information such as 'reportCards',
 * 'behavioralObservations', and 'payments' are stored in subcollections under the corresponding student
 * document to create clear relational boundaries and simplify security.
 *
 * Key Security Decisions:
 * - Default Deny: All collections are locked down by default. Access is granted explicitly based on roles.
 * - Role-Based Management: The ability to create, update, or delete core data is restricted to users
 *   with management roles ('Director', 'Directivo Docente', 'Administrador').
 * - Teacher-Specific Permissions: Teachers have specific write permissions related to their assigned
 *   duties, such as creating observations or managing grades for courses they teach.
 *
 * Denormalization for Authorization: The security model relies on denormalized data to function performantly.
 * - The `/teachers/{uid}` document contains a `role` field, which is critical for all permission checks.
 * - The `/courses/{courseId}` document contains a `teacherId`, allowing rules to verify teacher ownership.
 *
 * Structural Segregation: The system is designed for internal school staff. There is no access for external
 * users like parents or students. This simplifies the rules significantly as we do not need to check for
 * relationships between students and parents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the fundamental check for document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the user has one of the specified management roles.
     * ('Director', 'Directivo Docente', 'Administrador').
     * It assumes the user's role is stored in their /teachers/{uid} document.
     */
    function hasManagementRole() {
        let userDoc = get(/databases/$(database)/documents/teachers/$(request.auth.uid));
        return isSignedIn() && userDoc.data.role in ['Director', 'Directivo Docente', 'Administrador'];
    }

    /**
     * Checks for ownership on an existing document. Used for update/delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the requesting user is the teacher assigned to a specific course.
     * Requires a 'get' call to the course document.
     */
    function isTeacherOfCourse(courseId) {
      let courseDoc = get(/databases/$(database)/documents/courses/$(courseId));
      return isSignedIn() && request.auth.uid == courseDoc.data.teacherId;
    }

    /**
     * @description Rules for the 'students' collection. Student documents can only be accessed by authenticated staff.
     * @path /students/{studentId}
     * @allow (get, list) Any authenticated staff member can read student data.
     * @allow (create, update, delete) Only managers can create, update or delete students.
     * @principle Restricts access to student data to internal school staff, with write access limited to managers.
     */
    match /students/{studentId} {
      allow read: if isSignedIn();
      allow write: if hasManagementRole();

      /**
       * @description A student's behavioral observations. Writable by the observing teacher, readable by any staff.
       * @path /students/{studentId}/behavioralObservations/{behavioralObservationId}
       * @allow (read) Any signed-in staff member can read observations.
       * @allow (create) The creator must be the signed-in user or a manager.
       * @allow (update, delete) Only the teacher who created the observation or a manager can modify/delete it.
       * @principle Enforces creator ownership for modifications while allowing read access for all staff.
       */
      match /behavioralObservations/{behavioralObservationId} {
        allow read: if isSignedIn();
        allow create: if (isOwner(request.resource.data.teacherId) || hasManagementRole()) && request.resource.data.studentId == studentId;
        allow update, delete: if resource != null && (isOwner(resource.data.teacherId) || hasManagementRole());
      }

      /**
       * @description A student's payment records. Can only be managed by users with a management role.
       * @path /students/{studentId}/payments/{paymentId}
       * @allow (read, write) Only managers can read and write payment records.
       * @principle Restricts financial record management to authorized administrative staff.
       */
      match /payments/{paymentId} {
        allow read, write: if hasManagementRole();
      }

      /**
       * @description A student's academic report cards. Writable by the course teacher, readable by any staff.
       * @path /students/{studentId}/reportCards/{reportCardId}
       * @allow (read) Any signed-in staff member can read a report card.
       * @allow (create, update, delete) Only the teacher of the course or a manager can manage the report card.
       * @principle Validates relational integrity, ensuring only the correct teacher can create records for enrolled students.
       */
      match /reportCards/{reportCardId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn()
                      && request.resource.data.studentId == studentId
                      && isTeacherOfCourse(request.resource.data.courseId)
                      && studentId in get(/databases/$(database)/documents/courses/$(request.resource.data.courseId)).data.studentIds;
        allow update, delete: if resource != null && (isTeacherOfCourse(resource.data.courseId) || hasManagementRole());
      }
    }

    /**
     * @description Rules for the 'teachers' collection. This collection stores all staff, including admin roles.
     * @path /teachers/{teacherId}
     * @allow (get, list) Any authenticated user can read teacher/staff profiles.
     * @allow (create) New staff profiles can only be created by managers.
     * @allow (update) A staff member can update their own profile, or a manager can update any.
     * @allow (delete) Only managers can delete staff profiles.
     * @principle Allows self-service for staff while giving full administrative control to managers.
     */
    match /teachers/{teacherId} {
      allow get, list: if isSignedIn();
      allow create: if hasManagementRole();
      allow update: if isExistingOwner(teacherId) || hasManagementRole();
      allow delete: if hasManagementRole();
    }

    /**
     * @description Rules for the 'courses' collection and its subcollections.
     * @path /courses/{courseId}
     */
    match /courses/{courseId} {
      /**
       * @description Course information is primarily managed by the assigned teacher or managers.
       * @path /courses/{courseId}
       * @allow (get, list) Any signed-in user can read course details.
       * @allow (create, delete) Only managers can create or delete a course.
       * @allow (update) Only the assigned teacher or a manager can update the course.
       * @principle Secures course data by granting write access only to authorized personnel.
       */
      allow get, list: if isSignedIn();
      allow create, delete: if hasManagementRole();
      allow update: if resource != null && (isTeacherOfCourse(courseId) || hasManagementRole());

      /**
       * @description Learning achievements for a specific course. Writable by the course teacher or managers.
       * @path /courses/{courseId}/achievements/{achievementId}
       * @allow (read) Any authenticated user can read achievements.
       * @allow (write) The course teacher or a manager can manage achievements for their own course.
       * @principle Grants full control over achievements to the assigned teacher of the course or an admin.
       */
      match /achievements/{achievementId} {
        allow read: if isSignedIn();
        allow write: if isTeacherOfCourse(courseId) || hasManagementRole();
      }
    }

    /**
     * @description Rules for general school settings.
     * @path /settings/{settingId}
     * @allow (read) Anyone can read school settings to display public info like name and logo.
     * @allow (write) Only authenticated users with a management role can manage school settings.
     * @principle Centralizes school-wide configuration and restricts modification to administrators, while allowing public read access for UI purposes.
     */
    match /settings/{settingId} {
        allow read: if true;
        allow write: if hasManagementRole();
    }
  }
}
